{% extends "base.html" %}
{% block title %}Email Generator - Phishing Automation Tool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h1 class="mb-4"><i class="bi bi-envelope"></i> Email Template Generator</h1>

        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header"><i class="bi bi-gear"></i> Configuration</div>
                    <div class="card-body">
                        <form id="emailForm">
                            <div class="mb-3">
                                <label class="form-label">Template Type</label>
                                <select class="form-select" name="template_type" required>
                                    <option value="it_support">IT Support - Password Reset</option>
                                    <option value="hr_notification">HR - Benefits Enrollment</option>
                                    <option value="executive_impersonation">Executive Impersonation</option>
                                    <option value="document_share">Document Share</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Name</label>
                                <input type="text" class="form-control" name="name" value="John Doe">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Email</label>
                                <input type="email" class="form-control" name="email" value="john@example.com">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-control" name="company" value="Acme Corp">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phishing URL</label>
                                <input type="url" class="form-control" name="phishing_url" value="https://example.com" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Evasion Level</label>
                                <select class="form-select" name="evasion_level">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-magic"></i> Generate Email
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-envelope"></i> Generated Email</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyEmailHTML()" id="copyBtn" style="display:none;">
                            <i class="bi bi-clipboard"></i> Copy HTML
                        </button>
                    </div>
                    <div class="card-body" id="emailPreview">
                        <p class="text-muted text-center py-5">
                            Configure and click "Generate Email" to preview
                        </p>
                    </div>
                </div>

                <div class="card" id="emailHTML" style="display:none;">
                    <div class="card-header"><i class="bi bi-code"></i> HTML Source</div>
                    <div class="card-body">
                        <pre class="code-block" id="htmlSource"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let generatedHTML = '';

document.getElementById('emailForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const targetData = {
        name: formData.get('name'),
        email: formData.get('email'),
        company: formData.get('company'),
        phishing_url: formData.get('phishing_url')
    };

    const data = {
        template_type: formData.get('template_type'),
        evasion_level: formData.get('evasion_level'),
        target_data: targetData
    };

    try {
        const response = await axios.post('/api/email/generate', data);
        const email = response.data.email;

        generatedHTML = email.html_body;

        // Show preview
        document.getElementById('emailPreview').innerHTML = `
            <div class="mb-3">
                <strong>Subject:</strong> ${email.subject}
            </div>
            <hr>
            <iframe srcdoc="${email.html_body.replace(/"/g, '&quot;')}" style="width:100%; height:600px; border:1px solid #ddd;"></iframe>
        `;

        // Show HTML source
        document.getElementById('htmlSource').textContent = email.html_body;
        document.getElementById('emailHTML').style.display = 'block';
        document.getElementById('copyBtn').style.display = 'block';

        utils.showToast('Email generated successfully!', 'success');
    } catch (error) {
        utils.showToast('Failed to generate email', 'danger');
    }
});

function copyEmailHTML() {
    utils.copyToClipboard(generatedHTML);
}
</script>
{% endblock %}
