{% extends "base.html" %}

{% block title %}Admin Dashboard - Phishing Automation Tool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-shield-check"></i> Admin Dashboard
        </h1>
    </div>
</div>

<!-- User Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people"></i> User Management</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
                    <i class="bi bi-person-plus"></i> Create User
                </button>
            </div>
            <div class="card-body">
                <div id="usersTable">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audit Log -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> Security Audit Log</h5>
            </div>
            <div class="card-body">
                <div id="auditLog">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" name="password" required minlength="8">
                        <small class="form-text text-muted">Minimum 8 characters</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="is_admin" id="isAdmin">
                        <label class="form-check-label" for="isAdmin">Grant admin privileges</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">
                    <i class="bi bi-check-circle"></i> Create User
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load users
async function loadUsers() {
    try {
        const response = await axios.get('/api/admin/users');
        const users = response.data.users;

        const table = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Admin</th>
                            <th>Active</th>
                            <th>Created</th>
                            <th>Last Login</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${user.email}</td>
                                <td>${user.is_admin ? '<span class="badge bg-warning">Admin</span>' : '-'}</td>
                                <td>${user.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>'}</td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('usersTable').innerHTML = table;
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML =
            '<div class="alert alert-danger">Failed to load users</div>';
    }
}

// Create user
async function createUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);

    const data = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        is_admin: formData.get('is_admin') === 'on'
    };

    try {
        const csrfToken = sessionStorage.getItem('csrf_token');
        const response = await axios.post('/api/admin/users', data, {
            headers: { 'X-CSRF-Token': csrfToken }
        });

        if (response.data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
            modal.hide();
            form.reset();

            alert('User created successfully!\n\nAPI Key: ' + response.data.user.api_key + '\n\nSave this key - it won\'t be shown again!');

            loadUsers();
        }
    } catch (error) {
        alert('Failed to create user: ' + (error.response?.data?.error || 'Unknown error'));
    }
}

// Load audit log
async function loadAuditLog() {
    try {
        const response = await axios.get('/api/admin/audit-log?limit=50');
        const logs = response.data.logs;

        const table = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td>${log.user_id || '-'}</td>
                                <td><span class="badge bg-info">${log.action}</span></td>
                                <td>${log.details || '-'}</td>
                                <td><code>${log.ip_address || '-'}</code></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('auditLog').innerHTML = table;
    } catch (error) {
        console.error('Error loading audit log:', error);
        document.getElementById('auditLog').innerHTML =
            '<div class="alert alert-danger">Failed to load audit log</div>';
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadAuditLog();

    // Auto-refresh every 30 seconds
    setInterval(loadAuditLog, 30000);
});
</script>
{% endblock %}
